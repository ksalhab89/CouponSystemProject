package com.jhf.coupon.util;

import com.jhf.coupon.backend.security.PasswordHasher;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Utility test to generate bcrypt hash for admin password
 * Run this once to get the hash, then update .env file
 */
public class GenerateAdminHashTest {

    @Test
    void generateBcryptHashForAdminAndUpdateProperties() throws IOException {
        String password = "admin";
        String hash = PasswordHasher.hashPassword(password);

        System.out.println("\n" + "=".repeat(80));
        System.out.println("BCRYPT HASH GENERATED FOR PASSWORD: '" + password + "'");
        System.out.println("=".repeat(80));
        System.out.println(hash);
        System.out.println("=".repeat(80));
        System.out.println("\nUpdating src/test/resources/application.properties with new hash...");

        Path path = Paths.get("src/test/resources/application.properties");
        List<String> lines = Files.readAllLines(path);

        List<String> updatedLines = lines.stream()
                .map(line -> {
                    if (line.startsWith("admin.password=")) {
                        return "admin.password=" + hash;
                    }
                    return line;
                })
                .collect(Collectors.toList());

        Files.write(path, updatedLines);

        System.out.println("...done.");
        System.out.println("=".repeat(80) + "\n");

        // Verify it works
        boolean valid = PasswordHasher.verifyPassword(password, hash);
        System.out.println("Verification: " + (valid ? "✓ SUCCESS" : "✗ FAILED"));
    }
}
